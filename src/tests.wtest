import sonidos.*
import armas.*
import jugador.*
import enemigos.*
import tablero.*
import pantallas.*
import wollok.game.*
import direcciones.*
import estadosDestruccion.*
import animacion.*

//bala debe ser destruida
class NaveDePrueba {
	var property fueMovida = false
	var property fueDestruida = false
	var property estado
	const property animacion
	method mover(){
		fueMovida = true
	}
	
	method animarDestruccion(){
		fueDestruida = true
	}
	
	method estadoDestruccion(_estado){
		estado = _estado
	}
}

class AnimacionDePrueba{
	var property fueIniciada = false
	var property fueDetenida = false
	
	method iniciar(){
		fueIniciada = true
	}

	method detener(){
		fueDetenida = true
	}
}

describe "funcionalidadDelJuego"{
	
	method initialize(){
		game.clear()
		game.cellSize(20)
		game.width(40)
		game.height(30)
		
		sonidosManager.modoTest(true)
	
	}
	
  	test "nave enemiga se mueve cumpliendo la animacion" {
		const nave = new NaveEnemiga(position = game.at(5,5), agresion = 1, alColisionarConJugador = {})
		assert.equals(game.at(5,5), nave.position())
		
		nave.direccion(derecha)
		nave.mover()
		assert.equals(game.at(6,5), nave.position())

	}
	
	test"barra no debe salir del pantalla"{
		jugador.position(game.at(1,1))
		jugador.mover(izquierda)
		assert.equals(jugador.position(),game.at(0,1))
		assert.throwsException({jugador.mover(izquierda)})
	}
	
	
}


describe "flotaEnemiga" {
	
	const animacionDePrueba = new AnimacionDePrueba()
	const naveDePrueba = new NaveDePrueba(animacion = animacionDePrueba, estado = null)
	
	method initialize(){
		flotaEnemiga.agregar(naveDePrueba)
		flotaEnemiga.ejecutarAlMorir({})
	}
	
	test "No está muerta si tiene naves" {				
		assert.notThat(flotaEnemiga.estaMuerta())		
		assert.that(animacionDePrueba.fueIniciada())
	}
	
	test "Está muerta si no tiene naves" {				
		flotaEnemiga.remover(naveDePrueba)
		assert.that(flotaEnemiga.estaMuerta())
		//assert.that(naveDePrueba.fueDestruida())
	}
	
	test "Mueve a las naves de la flota" {
		assert.notThat(naveDePrueba.fueMovida())
		flotaEnemiga.mover()
		assert.that(naveDePrueba.fueMovida())
	}
}


describe "Estado PuedeSerDestruida" {

	test "Envia mensajes al ser ejecutado"{
		sonidosManager.modoTest(true)
		const animacionDePrueba = new AnimacionDePrueba()
		const naveDePrueba = new NaveDePrueba(animacion = animacionDePrueba, estado = null)
		flotaEnemiga.agregar(naveDePrueba)
		flotaEnemiga.ejecutarAlMorir({})
		const estado = new PuedeSerDestruida()
		estado.ejecutar(naveDePrueba)
		assert.equals(100, score.puntos())
		assert.that(naveDePrueba.fueDestruida())
		assert.that(flotaEnemiga.estaMuerta())
		assert.that(naveDePrueba.estado() != null)
	}
}

describe "Animaciones" {
	method initialize(){
		game.cellSize(20)
		game.width(40)
		game.height(30)
		
		sonidosManager.modoTest(true)

}
	
	
	test "Enemigo"{
		const naveAhora = new NaveEnemiga(position = game.at(2,5),agresion = null, alColisionarConJugador = null)
				
		assert.equals(naveAhora.image(), "enemigo-1.png")
		naveAhora.animacion().animar()
		assert.equals(naveAhora.image(), "enemigo-2.png")
		naveAhora.animacion().animar()
		assert.equals(naveAhora.image(), "enemigo-3.png")
		naveAhora.animacion().animar()
		assert.equals(naveAhora.image(), "enemigo-4.png")
		naveAhora.animacion().animar()
		assert.equals(naveAhora.image(), "enemigo-5.png")
		naveAhora.animacion().animar()
		assert.equals(naveAhora.image(), "enemigo-6.png")
	}
	test "MenuPrincipal"{
		const background = new AnimacionMenuPrincipal()
		game.addVisual(background)
		assert.equals(background.image(), "menu-1.png")
		background.animar()
		assert.equals(background.image(), "menu-2.png")
		background.animar()
		assert.equals(background.image(), "menu-3.png")
		background.animar()
		assert.equals(background.image(), "menu-4.png")
		background.animar()
		assert.equals(background.image(), "menu-5.png")
		background.animar()
		assert.equals(background.image(), "menu-6.png")
		background.animar()
		assert.equals(background.image(), "menu-7.png")
		background.animar()
		assert.equals(background.image(), "menu-8.png")
		
	}
	
}
describe "colisiones"{
	method initialize(){
		game.cellSize(20)
		game.width(40)
		game.height(30)
		
		sonidosManager.modoTest(true)
		
	}
	test "bala colisiona con nave"{
		const bala = new TiroSimple(position=game.at(3,2))
		const naveAhora = new NaveEnemiga(position = game.at(3,3),agresion = null, alColisionarConJugador = {})
		
//		game.addVisual(bala)
//		game.addVisual(naveAhora)
		
		bala.mover()
		assert.equals(naveAhora.image(), "esplosion.png")
		
	}
	test "Jugador colisiona con NaveEnemiga"{
		const naveAhora = new NaveEnemiga(position = game.at(3,3),agresion = null, alColisionarConJugador = {})
		
		
		jugador.position(game.at(3,2))
		game.addVisual(jugador)
		game.addVisual(naveAhora)
		assert.that(jugador.position()== game.at(3,2))
		assert.that(naveAhora.position()== game.at(3,3))
		
		assert.equals(game.allVisuals(), "esplosion.png")
		
		
		
	}
}






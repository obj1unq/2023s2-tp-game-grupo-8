import sonidos.*
import armas.*
import jugador.*
import enemigos.*
import tablero.*
import pantallas.*
import wollok.game.*
import direcciones.*
import estadosDestruccion.*


class NaveDePrueba {
	var property fueMovida = false
	var property fueDestruida = false
	var property estado
	const property animacion
	method mover(){
		fueMovida = true
	}
	
	method animarDestruccion(){
		fueDestruida = true
	}
	
	method estadoDestruccion(_estado){
		estado = _estado
	}
}

class AnimacionDePrueba{
	var property fueIniciada = false
	var property fueDetenida = false
	
	method iniciar(){
		fueIniciada = true
	}

	method detener(){
		fueDetenida = true
	}
}

describe "funcionalidadDelJuego"{
	
	method initialize(){
		game.clear()
		game.cellSize(20)
		game.width(40)
		game.height(30)
		
		sonidosManager.modoTest(true)
	
	}
	
  	test "nave enemiga se mueve cumpliendo la animacion" {
		const nave = new NaveEnemiga(position = game.at(5,5), agresion = 1, alColisionarConJugador = {})
		assert.equals(game.at(5,5), nave.position())
		
		nave.direccion(derecha)
		nave.mover()
		assert.equals(game.at(6,5), nave.position())

	}
	
	test"barra no debe salir del pantalla"{
		jugador.position(game.at(1,1))
		jugador.mover(izquierda)
		assert.equals(jugador.position(),game.at(0,1))
		assert.throwsException({jugador.mover(izquierda)})
	}
	
	
}


describe "flotaEnemiga" {
	
	const animacionDePrueba = new AnimacionDePrueba()
	const naveDePrueba = new NaveDePrueba(animacion = animacionDePrueba, estado = null)
	
	method initialize(){
		flotaEnemiga.agregar(naveDePrueba)
		flotaEnemiga.ejecutarAlMorir({})
	}
	
	test "No está muerta si tiene naves" {				
		assert.notThat(flotaEnemiga.estaMuerta())		
		assert.that(animacionDePrueba.fueIniciada())
	}
	
	test "Está muerta si no tiene naves" {				
		flotaEnemiga.remover(naveDePrueba)
		assert.that(flotaEnemiga.estaMuerta())
		//assert.that(naveDePrueba.fueDestruida())
	}
	
	test "Mueve a las naves de la flota" {
		assert.notThat(naveDePrueba.fueMovida())
		flotaEnemiga.mover()
		assert.that(naveDePrueba.fueMovida())
	}
}


describe "Estado PuedeSerDestruida" {

	test "Envia mensajes al ser ejecutado"{
		sonidosManager.modoTest(true)
		const animacionDePrueba = new AnimacionDePrueba()
		const naveDePrueba = new NaveDePrueba(animacion = animacionDePrueba, estado = null)
		flotaEnemiga.agregar(naveDePrueba)
		flotaEnemiga.ejecutarAlMorir({})
		const estado = new PuedeSerDestruida()
		estado.ejecutar(naveDePrueba)
		assert.equals(100, score.puntos())
		assert.that(naveDePrueba.fueDestruida())
		assert.that(flotaEnemiga.estaMuerta())
		assert.that(naveDePrueba.estado() != null)
	}
}